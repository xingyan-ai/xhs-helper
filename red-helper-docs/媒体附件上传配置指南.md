# 📎 媒体附件上传配置指南（封面/图片/视频）

> 目的：让飞书多维表格里同时拥有  
> - **可点击的链接**（超链接字段）  
> - **可预览的附件**（附件字段，需要 `file_token`）  
> 本文指导你在 **Coze 工作流**中完成“链接 → 附件”的轻量转换。

---

## 1. 你会用到的字段（飞书多维表格）

请确认表格里有以下字段（名称可改，但类型必须一致）：

- `封面`：**超链接**
- `封面附件`：**附件**
- `图片附件`：**多行文本**（用“图1=(url)”格式）
- `视频链接`：**超链接**
- `视频附件`：**附件**

> ✅ 为什么要分开？  
> - **超链接字段**直接写 URL 即可  
> - **附件字段**必须写 `file_token`，不能直接写 URL

---

## 2. 插件应传的字段（你已经具备）

插件侧会传这些内容（示例）：

```json
{
  "封面": "https://...cover.jpg",
  "图片附件": "图1=(https://...1.jpg)\n图2=(https://...2.jpg)",
  "视频链接": "https://...video.mp4"
}
```

**注意：**  
`图片附件` 是多行文本，里面是 URL；  
`封面`、`视频链接` 是单条 URL。

---

## 3. Coze 工作流配置思路（核心）

你需要做 3 件事：

1. **保留“链接字段”原样写入**  
   - `封面`、`视频链接` 直接写入飞书（超链接字段）
2. **把 URL 转成附件 `file_token`**  
   - 用 Coze “HTTP 请求 + 飞书上传文件接口”
3. **把 `file_token` 写入附件字段**  
   - `封面附件`、`视频附件`

---

## 4. 具体工作流节点（建议顺序）

> 以下以“单篇笔记”工作流为例。批量/博主信息同理。

### 4.1 解析输入（已有）
你的解析节点（如“2.6 解析并处理笔记数据”）输出：  
`封面`、`图片附件`、`视频链接` 等字段。

### 4.2 上传封面为附件（具体配置）
下面给你一个**“能落地的最小配置”**，不写代码也能做：

**步骤 A：下载封面（HTTP 请求节点）**
1. 新增节点：`HTTP 请求`，命名 `下载封面`
2. 配置：
   - 方法：`GET`
   - URL：选择变量 `封面`
   - 响应类型：选择 `文件/二进制`（如果没有该选项，选 `原始响应`）
3. 输出变量命名为：`cover_file`

**步骤 B：上传为飞书文件（上传文件节点）**
1. 新增节点：`飞书 > 上传文件`（或类似名称）
2. 配置：
   - 文件来源：选择上一步 `cover_file`
   - 文件名：`cover.jpg`（或任意固定名）
3. 输出变量命名为：`cover_file_token`

> 如果你的 Coze 没有“上传文件”节点：  
> 使用 `HTTP 请求` 调用飞书上传接口（见下方“备用方案”）

### 4.3 上传视频为附件（具体配置）
与封面完全一样，只是 URL 换成 `视频链接`：

**步骤 A：下载视频（HTTP 请求节点）**
- URL：选择变量 `视频链接`
- 输出：`video_file`

**步骤 B：上传视频（上传文件节点）**
- 文件来源：`video_file`
- 文件名：`video.mp4`
- 输出：`video_file_token`

> 视频较大时，建议把“超时”设置为 30s 或更高。

### 4.4 写入飞书多维表格
在“新增/更新记录”节点里：

**写入字段：**
- `封面` = 原始 URL
- `封面附件` = `[{ "file_token": cover_file_token }]`
- `图片附件` = 原始多行文本（图1=(url) 格式）
- `视频链接` = 原始 URL
- `视频附件` = `[{ "file_token": video_file_token }]`

---

## 5. 备用方案：没有“上传文件”节点时怎么做

如果你的 Coze 没有内置“飞书上传文件”节点，可以用 **HTTP 请求** 直接调飞书接口：

1. 新增 `HTTP 请求` 节点（命名：`上传到飞书`）
2. 方法：`POST`
3. URL：
```
https://open.feishu.cn/open-apis/drive/v1/medias/upload_all
```
4. Header（从授权节点获取 token）：
```
Authorization: Bearer <你的token>
```
5. Body（表单或 multipart）需要包含：
   - `file_name`：文件名
   - `file`：上一步下载到的文件
6. 返回结果里会有 `file_token`

> 注意：这个方式要求你能拿到飞书的访问 token。  
> 如果你用的是“共享授权 / 独立授权”，优先使用内置上传节点。

---

## 6. 附件字段写入格式（必须这样）

飞书附件字段 **必须** 用如下结构：

```json
[
  { "file_token": "file_xxxxx", "name": "cover.jpg" }
]
```

如果没有 `file_token`，附件字段会失败。

---

## 7. 常见问题排查

### Q1：附件写入失败（AttachFieldConvFail）
**原因：** 传了 URL / 文本，而不是 `file_token`  
**解决：** 先上传文件换 token，再写入

### Q2：视频链接有，但附件为空
**原因：** 视频下载失败 / 上传失败  
**解决：**  
- 检查视频 URL 是否可直接访问  
- 增加请求超时  
- 先验证 HTTP 节点能成功下载

### Q3：图片附件显示不完整
**原因：** `图片附件`字段是多行文本，格式不标准  
**正确格式：**
```
图1=(url1)
图2=(url2)
```

---

## 8. 推荐的字段映射（总结）

| 字段名 | 类型 | 写入方式 |
| --- | --- | --- |
| 封面 | 超链接 | 直接写 URL |
| 封面附件 | 附件 | 上传 → file_token |
| 图片附件 | 多行文本 | 图X=(url) |
| 视频链接 | 超链接 | 直接写 URL |
| 视频附件 | 附件 | 上传 → file_token |

---

---

## 9. 超详细配置（逐节点、逐字段、含代码）

> 目标：让你可以“照抄照做”，不需要猜。

### 9.1 飞书多维表格字段配置（必须先做）

在飞书多维表格里新增/检查下列字段：

| 字段名 | 类型 | 备注 |
| --- | --- | --- |
| 标题 | 文本 | 采集标题 |
| 笔记链接 | 超链接 | 小红书笔记链接 |
| 笔记类型 | 单选/文本 | 图文/视频 |
| 作者 | 文本 | 作者昵称 |
| 正文 | 多行文本 | 笔记正文 |
| 话题标签 | 多行文本 | 可逗号分隔 |
| 封面 | 超链接 | 单条 URL |
| 封面附件 | 附件 | **必须 file_token** |
| 图片附件 | 多行文本 | 图1=(url) 多行 |
| 视频链接 | 超链接 | 单条 URL |
| 视频附件 | 附件 | **必须 file_token** |
| 点赞数 | 数字 | - |
| 收藏数 | 数字 | - |
| 评论数 | 数字 | - |
| 发布时间 | 日期时间 | 字符串或时间戳皆可 |
| 采集时间 | 日期时间 | 字符串或时间戳皆可 |

> **注意：** 附件字段（封面附件/视频附件）必须写 `file_token`，否则会失败。

---

### 9.2 Coze 工作流节点设计（完整流程）

建议节点顺序（命名只是建议，你可替换）：

1. **开始**
2. **解析输入（代码节点）**
3. **下载封面（HTTP 请求）**
4. **上传封面（飞书上传文件）**
5. **下载视频（HTTP 请求）**
6. **上传视频（飞书上传文件）**
7. **写入表格（新增/更新记录）**
8. **结束**

下面逐节点详细说明：

---

### 节点 1：开始

**输入参数（必须）**  
与插件保持一致（严格大小写）：

- `orderId` (String)
- `baseToken` (String)
- `orderurl` (String)
- `tableurl` (String)
- `body` (String, JSON)

---

### 节点 2：解析输入（代码节点）

**作用**：把 `body` 解析成字段，并输出给后续节点使用。

**输入：**
- `body`（来自开始节点）

**输出：**
- `record`（Object，单条笔记字段对象）
- `cover_url`（String）
- `video_url`（String）
- `image_text`（String）

**代码（可直接复制）：**
```javascript
// 解析插件传来的 body（JSON 字符串）
let rawBody = input?.body || input?.['str.body'] || input?.str?.body || input?.params?.body;
if (!rawBody) {
  return { record: {}, cover_url: '', video_url: '', image_text: '' };
}

let parsed = {};
try {
  parsed = JSON.parse(rawBody);
} catch (e) {
  return { record: {}, cover_url: '', video_url: '', image_text: '' };
}

const record = parsed?.records?.[0]?.fields || {};

return {
  record,
  cover_url: record['封面'] || '',
  video_url: record['视频链接'] || '',
  image_text: record['图片附件'] || ''
};
```

---

### 节点 3：下载封面（HTTP 请求）

**作用**：把封面 URL 下载成文件（用于上传）

**配置：**
- 方法：`GET`
- URL：选择变量 `cover_url`
- 响应类型：`文件/二进制`

**输出变量名：**
- `cover_file`

> 如果封面为空，可在节点前加判断（封面为空则跳过上传）

---

### 节点 4：上传封面（飞书上传文件）

**作用**：把 `cover_file` 上传到飞书，得到 `file_token`

**配置：**
- 文件来源：`cover_file`
- 文件名：`cover.jpg`

**输出变量名：**
- `cover_file_token`

---

### 节点 5：下载视频（HTTP 请求）

**作用**：下载视频文件

**配置：**
- 方法：`GET`
- URL：选择变量 `video_url`
- 响应类型：`文件/二进制`
- 超时：`30s` 或更高

**输出变量名：**
- `video_file`

---

### 节点 6：上传视频（飞书上传文件）

**作用**：上传视频，得到 `file_token`

**配置：**
- 文件来源：`video_file`
- 文件名：`video.mp4`

**输出变量名：**
- `video_file_token`

---

### 节点 7：新增/更新记录（飞书多维表格）

**作用**：写入最终字段

**字段映射（示例）：**

| 字段名 | 变量值 |
| --- | --- |
| 标题 | `record.标题` |
| 笔记链接 | `record.笔记链接` |
| 笔记类型 | `record.笔记类型` |
| 作者 | `record.作者` |
| 正文 | `record.正文` |
| 话题标签 | `record.话题标签` |
| 封面 | `record.封面` |
| 封面附件 | `[{"file_token": cover_file_token}]` |
| 图片附件 | `record.图片附件` |
| 视频链接 | `record.视频链接` |
| 视频附件 | `[{"file_token": video_file_token}]` |
| 点赞数 | `record.点赞数` |
| 收藏数 | `record.收藏数` |
| 评论数 | `record.评论数` |
| 发布时间 | `record.发布时间` |
| 采集时间 | `record.采集时间` |

> 如果封面/视频为空，`封面附件`、`视频附件` 应该写空数组 `[]`，避免报错。

---

### 节点 8：结束节点（返回结果给插件）

建议输出 3 个变量（插件已支持）：

- `orderId_result`（可填任何非空值表示“有效”）
- `edit_records`（更新节点输出）
- `add_records`（新增节点输出）

> 插件判定逻辑：
> - `orderId_result` 有值 → 订单有效  
> - `edit_records` 或 `add_records` 有值 → 写入成功  

---

## 10. 没有“飞书上传文件”节点时的替代代码

如果你没有内置上传节点，使用 HTTP 请求调用飞书上传接口：

**HTTP 请求配置：**
- 方法：`POST`
- URL：`https://open.feishu.cn/open-apis/drive/v1/medias/upload_all`
- Header：
  - `Authorization: Bearer {{你的token}}`
- Body：`multipart/form-data`
  - `file_name`: `cover.jpg`
  - `file`: 上一步下载的 `cover_file`

**返回结果里取：**
```json
{
  "data": {
    "file_token": "file_xxx"
  }
}
```

---

如果你愿意，我可以继续为你：
- 按你当前工作流节点命名 **一对一对照变量**
- 给出“节点截图版配置清单”
