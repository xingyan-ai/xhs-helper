# 📦 订单号管理与授权验证指南

## 🎯 适用场景

你的订单号是从**小红书店铺**生成的，需要一个方便的方式来管理和验证这些订单号。

本指南提供订单管理和授权验证的完整方案，**有效防止工作流被滥用**。

推荐使用**方案1（飞书表格管理）**。

---

## 🔒 防止滥用机制

为了保护你的 Coze 工作流资源，防止未授权用户滥用，红薯助手内置了完善的授权验证机制：

### 核心保护措施

1. **订单号验证**  
   - 每次同步数据前，必须验证订单号
   - 订单号存储在飞书多维表格中
   - 只有状态为"有效"且未过期的订单才能使用

2. **有效期管理**  
   - 每个订单都有明确的到期时间
   - 过期订单自动失效，无法继续使用
   - 支持手动禁用订单

3. **使用次数限制（可选）**  
   - 可为每个订单设置剩余次数
   - 每次同步自动扣减1次
   - 次数用完自动禁用

4. **实时验证**  
   - 每次同步都会实时查询飞书表格
   - 即使订单刚过期或被禁用，立即生效
   - 无缓存，无漏洞

### 安全架构

```
用户使用插件
  ↓
输入订单号
  ↓
Coze 工作流接收请求
  ↓
【第一道防线】查询飞书「订单管理」表格
  ├─ 订单号不存在 → 拒绝 ❌
  ├─ 状态不是"有效" → 拒绝 ❌
  ├─ 已过期 → 拒绝 ❌
  └─ 剩余次数≤0 → 拒绝 ❌
  ↓
【通过验证】执行数据同步
  ↓
【第二道防线】扣减剩余次数
  ↓
完成
```

### 为什么这样设计是安全的？

1. ✅ **Token 不暴露**  
   用户只知道订单号，无法获取飞书授权码或 Coze Token

2. ✅ **工作流 ID 不重要**  
   即使有人知道工作流 ID，没有有效订单号也无法使用

3. ✅ **实时控制**  
   在飞书表格中修改订单状态，立即生效

4. ✅ **完整审计**  
   所有使用记录都保存在飞书表格中，可追溯

---

## 方案1：使用飞书表格管理订单号 ⭐ 推荐

### 为什么推荐这个方案？

- ✅ **可视化管理** - 像 Excel 一样直观
- ✅ **批量导入** - 可以从小红书店铺批量导出订单后导入
- ✅ **团队协作** - 多人可以同时管理
- ✅ **功能丰富** - 支持筛选、排序、统计
- ✅ **无需编程** - 不需要写代码维护
- ✅ **实时更新** - 修改后立即生效

---

## 📋 完整实施步骤

### 第一步：创建订单管理表格

1. 登录飞书
2. 点击「云文档」→「新建」→「多维表格」
3. 命名为：`订单管理`

### 第二步：配置表格字段

创建以下字段：

| 字段名称 | 字段类型 | 是否必填 | 说明 |
|---------|---------|---------|------|
| 订单号 | 文本 | ✅ 必填 | 小红书店铺的订单号 |
| 用户名 | 文本 | 推荐填 | 购买用户的名称 |
| 联系方式 | 文本 | 可选 | 手机号或微信号 |
| 购买时间 | 日期时间 | 推荐填 | 订单生成时间 |
| 到期时间 | 日期 | ✅ 必填 | 有效期截止日期 |
| 是否有效 | 单选 | ✅ 必填 | 订单当前状态 |
| 套餐类型 | 单选 | 可选 | 购买的套餐版本 |
| 剩余次数 | 数字 | 可选 | 可使用次数 |
| 已使用次数 | 数字 | 可选 | 已使用次数 |
| 最后使用时间 | 日期时间 | 自动 | 最后一次使用的时间 |
| 备注 | 多行文本 | 可选 | 其他说明 |

#### 单选字段「是否有效」的选项：

1. 点击「是否有效」字段设置
2. 添加以下选项：
   - ✅ **有效**（绿色）
   - ⏰ **已过期**（灰色）
   - 🚫 **已禁用**（红色）

#### 单选字段「套餐类型」的选项（可选）：

- 基础版
- 专业版
- 旗舰版
- 体验版

### 第三步：导入订单数据

#### 方式1：手动添加（适合少量订单）

1. 点击表格底部的「+」
2. 填写订单信息
3. 保存

#### 方式2：从小红书店铺导出（推荐）

1. **导出订单数据**
   - 登录小红书店铺后台
   - 找到「订单管理」
   - 选择「导出订单」
   - 下载 Excel 或 CSV 文件

2. **整理数据格式**
   - 打开导出的文件
   - 确保有以下列：
     - 订单号
     - 用户名（或买家昵称）
     - 下单时间
   - 添加新列：
     - 到期时间（根据购买时间 + 有效期计算）
     - 是否有效（默认填"有效"）

3. **导入到飞书**
   - 在飞书表格中点击右上角「...」
   - 选择「导入数据」
   - 上传整理好的 Excel 文件
   - 映射字段（订单号→订单号，用户名→用户名...）
   - 确认导入

#### 方式3：使用 Excel 模板批量添加

1. 下载模板：创建一个 Excel 文件，包含以下列：

```
订单号 | 用户名 | 购买时间 | 到期时间 | 是否有效 | 套餐类型 | 剩余次数
XHS001 | 张三   | 2025-01-04 | 2025-12-31 | 有效 | 专业版 | 100
XHS002 | 李四   | 2025-01-05 | 2026-01-05 | 有效 | 基础版 | 50
```

2. 填写订单信息
3. 导入到飞书表格

### 第四步：在 Coze 工作流中配置验证

#### 4.1 修改「验证订单号」节点

在 Coze 工作流的「第二步」中，**删除原来的代码节点**，改为：

1. **添加「飞书多维表格 - 查询记录」节点**
   - 节点名称：`查询订单信息`
   - 授权方式：Personal Access Token
   - Token：`{{开始.baseToken}}`
   - 选择表格：「订单管理」
   - 筛选条件：
     - `订单号` 等于 `{{开始.orderId}}`
     - `是否有效` 等于 `有效`
     - （可选）`到期时间` 大于等于 `今天`

2. **添加「代码」节点**
   - 节点名称：`处理验证结果`
   - 代码：

```javascript
async function main(input) {
  const { records } = input;
  
  // 检查是否查询到有效订单
  const isValid = records && records.length > 0;
  
  if (isValid) {
    const order = records[0].fields;
    
    return {
      orderId_result: true,
      message: `订单验证成功，欢迎 ${order['用户名'] || '用户'} 使用！`,
      recordId: records[0].record_id,  // 保存记录ID，用于后续更新
      orderInfo: {
        userName: order['用户名'] || '',
        套餐类型: order['套餐类型'] || '',
        到期时间: order['到期时间'] || '',
        剩余次数: order['剩余次数'] || 0
      }
    };
  } else {
    return {
      orderId_result: false,
      message: '订单号无效、已过期或已禁用，请检查后重试'
    };
  }
}
```

   - 输入映射：`records` → `{{查询订单信息.records}}`

3. **修改「条件判断」节点**
   - 条件：`{{处理验证结果.orderId_result}} == true`

#### 4.2 （可选）添加使用记录更新

如果你想在每次同步后记录使用情况：

1. 在工作流末尾（「写入飞书表格」节点之后）
2. 添加「飞书多维表格 - 更新记录」节点
   - 节点名称：`更新使用记录`
   - 表格：「订单管理」
   - 记录ID：`{{处理验证结果.recordId}}`
   - 更新字段：
     - `最后使用时间` = `当前时间`
     - `已使用次数` = `{{处理验证结果.orderInfo.已使用次数}} + 1`

#### 4.3 （可选）添加次数扣减

如果启用了「剩余次数」功能：

1. 在「更新使用记录」节点中
2. 额外更新字段：
   - `剩余次数` = `{{处理验证结果.orderInfo.剩余次数}} - 1`

3. 添加「条件判断」节点：
   - 条件：`{{处理验证结果.orderInfo.剩余次数}} <= 0`
   - 如果为 true，自动将「是否有效」改为「已禁用」

---

## 📊 日常管理

### 查看订单列表

**默认视图：全部订单**
- 显示所有订单
- 按「购买时间」降序排列

**创建自定义视图：**

#### 视图1：有效订单
- 筛选：`是否有效` = `有效`
- 排序：按「到期时间」升序
- 用途：查看所有正在使用的订单

#### 视图2：即将过期
- 筛选：
  - `是否有效` = `有效`
  - `到期时间` 在 `未来30天内`
- 排序：按「到期时间」升序
- 用途：提前通知用户续费

#### 视图3：活跃用户
- 筛选：`是否有效` = `有效`
- 排序：按「已使用次数」降序
- 用途：查看使用频率高的用户

#### 视图4：次数不足
- 筛选：
  - `是否有效` = `有效`
  - `剩余次数` < `10`
- 排序：按「剩余次数」升序
- 用途：提醒用户续费或升级套餐

### 处理过期订单

**手动处理：**
1. 打开「订单管理」表格
2. 筛选：`到期时间` < `今天`
3. 批量选中这些订单
4. 将「是否有效」改为「已过期」

**自动处理（推荐）：**
1. 创建飞书自动化规则
2. 触发条件：`到期时间` = `今天`
3. 执行动作：将「是否有效」改为「已过期」

### 禁用订单

如果需要手动禁用某个订单（如退款、违规等）：

1. 找到对应订单
2. 将「是否有效」改为「已禁用」
3. 在「备注」中填写禁用原因
4. 保存

用户将立即无法使用该订单号。

### 订单续费

当用户续费时：

1. 找到原订单
2. 更新「到期时间」为新的到期日期
3. 如果有次数限制，增加「剩余次数」
4. 确保「是否有效」为「有效」
5. 在「备注」中记录续费信息

---

## 📈 数据统计

### 基础统计

在表格顶部可以看到：
- 总订单数
- 有效订单数
- 已过期订单数

### 高级统计（使用飞书仪表盘）

1. 创建飞书仪表盘
2. 添加图表：

**图表1：订单状态分布**
- 类型：饼图
- 数据：按「是否有效」分组统计

**图表2：套餐类型分布**
- 类型：柱状图
- 数据：按「套餐类型」分组统计

**图表3：每日新增订单**
- 类型：折线图
- 数据：按「购买时间」的日期分组统计

**图表4：使用频率 TOP10**
- 类型：排行榜
- 数据：按「已使用次数」降序，取前10

---

## 🔔 自动化通知（高级）

### 配置飞书机器人通知

#### 场景1：订单即将过期提醒

1. 创建飞书机器人
2. 在「订单管理」表格中添加自动化
3. 触发条件：`到期时间` = `7天后`
4. 执行动作：发送飞书消息
5. 消息内容：

```
【订单到期提醒】
用户：{{用户名}}
订单号：{{订单号}}
到期时间：{{到期时间}}
请及时联系用户续费。
```

#### 场景2：次数不足提醒

1. 触发条件：`剩余次数` < `10`
2. 执行动作：发送飞书消息
3. 消息内容：

```
【次数不足提醒】
用户：{{用户名}}
订单号：{{订单号}}
剩余次数：{{剩余次数}}
建议联系用户续费或升级套餐。
```

---

## 🔒 安全建议与最佳实践

### 1. 权限管理

**飞书表格权限：**
- ✅ 只给必要的人员开放「订单管理」表格编辑权限
- ✅ 其他人员只给查看权限
- ✅ 定期审查权限列表
- ⚠️ 不要公开分享表格链接

**Coze 工作流安全：**
- ✅ 不要公开分享工作流 ID（虽然知道了也无法滥用）
- ✅ 定期更换 Coze API Token
- ✅ 在 Coze 平台查看工作流运行日志，监控异常调用

### 2. 数据备份

- ✅ 每周导出一次订单数据作为备份
- ✅ 保存在安全的地方
- ✅ 至少保留3个月的历史备份

### 3. 敏感信息保护

- ✅ 不要在「备注」中记录密码等敏感信息
- ✅ 联系方式等信息注意脱敏
- ✅ 定期清理已过期订单的个人信息

### 4. 防止滥用监控

**设置告警通知：**

在飞书表格中创建自动化规则：

1. **异常使用频率告警**  
   - 触发条件：同一订单「最后使用时间」频繁更新（如1小时内超过10次）
   - 执行动作：发送飞书消息通知管理员
   - 用途：发现可能的滥用行为

2. **剩余次数告警**  
   - 触发条件：「剩余次数」≤ 10
   - 执行动作：发送飞书消息通知
   - 用途：提醒用户续费

3. **即将过期告警**  
   - 触发条件：「到期时间」在未来7天内
   - 执行动作：发送飞书消息通知
   - 用途：提前通知续费

**在 Coze 平台查看日志：**

1. 进入 Coze 工作流详情页
2. 查看「运行历史」
3. 关注以下异常：
   - 短时间内大量失败请求（可能是恶意尝试）
   - 来自同一订单号的高频调用
   - 非工作时间的异常请求

### 5. Token 安全管理

**飞书授权码（baseToken）：**
- 🔴 **极其敏感**，不要泄露给任何人
- ✅ 定期更换（建议每3个月）
- ✅ 如果怀疑泄露，立即重新生成
- ✅ 不要在代码或文档中硬编码

**Coze API Token：**
- 🔴 **极其敏感**，不要泄露
- ✅ 定期更换
- ✅ 使用 IP 白名单（如果 Coze 支持）

**订单号：**
- 🟡 **中等敏感**
- ✅ 不要在公开渠道分享
- ✅ 发给用户时使用私密方式（如飞书私聊、邮件）

---

## 💡 最佳实践

### 1. 订单号规则

建议使用有规律的订单号格式，例如：
- `XHS20250104001`（XHS + 日期 + 序号）
- `PRO-2025-001`（套餐类型 + 年份 + 序号）

便于识别和管理。

### 2. 套餐设计

建议设置不同的套餐：
- **体验版**：7天有效期，20次使用
- **基础版**：30天有效期，100次使用
- **专业版**：90天有效期，500次使用
- **旗舰版**：365天有效期，无限次使用

### 3. 用户沟通

- ✅ 订单激活后，发送使用说明
- ✅ 到期前7天，发送续费提醒
- ✅ 次数不足时，推荐升级套餐
- ✅ 提供订单查询入口

---

## 🆚 三种方案对比

| 特性 | 方案1（飞书表格）⭐ | 方案2（外部API） | 方案3（硬编码） |
|-----|------------------|-----------------|---------------|
| **易用性** | ⭐⭐⭐⭐⭐ 非常简单 | ⭐⭐⭐ 需要技术 | ⭐⭐⭐⭐⭐ 最简单 |
| **灵活性** | ⭐⭐⭐⭐⭐ 功能丰富 | ⭐⭐⭐⭐ 可定制 | ⭐ 无法扩展 |
| **维护成本** | ⭐⭐⭐⭐ 低 | ⭐⭐⭐ 中等 | ⭐ 高（需改代码） |
| **实时性** | ⭐⭐⭐⭐ 秒级生效 | ⭐⭐⭐⭐⭐ 实时 | ⭐⭐⭐⭐⭐ 实时 |
| **团队协作** | ⭐⭐⭐⭐⭐ 支持 | ⭐⭐⭐ 需权限 | ⭐ 不支持 |
| **数据统计** | ⭐⭐⭐⭐⭐ 丰富 | ⭐⭐⭐ 需开发 | ⭐ 无 |
| **适用规模** | 1-10000订单 | 10000+订单 | 仅测试 |

---

## 🚨 应急响应

### 如果怀疑工作流被滥用

**立即采取的措施：**

1. **暂时禁用所有订单**  
   - 在飞书表格中，批量将「是否有效」改为「已禁用」
   - 用户将立即无法使用

2. **更换 Token**  
   - 重新生成飞书授权码
   - 重新生成 Coze API Token
   - 通知正常用户更新插件配置

3. **审查日志**  
   - 查看 Coze 工作流运行历史
   - 找出可疑的订单号和请求来源
   - 记录证据

4. **清理并恢复**  
   - 删除可疑订单
   - 重新启用正常用户的订单
   - 通知用户恢复使用

### 如何判断是否被滥用？

**异常信号：**
- ❗ Coze 工作流调用次数突然激增
- ❗ 出现大量失败的验证请求
- ❗ 飞书表格「已使用次数」异常增长
- ❗ 非正常时间段的高频调用（如凌晨2-5点）
- ❗ 同一订单号短时间内重复调用

**排查步骤：**

1. 打开 Coze 平台，查看工作流运行历史
2. 筛选出异常时间段的请求
3. 查看请求日志中的订单号
4. 在飞书「订单管理」表格中定位该订单
5. 查看订单的使用记录和用户信息
6. 判断是否为滥用

---

## 📞 常见问题

### Q1: 如何批量导入订单？

**答：** 
1. 准备 Excel 文件，包含订单号、用户名、到期时间等信息
2. 在飞书表格中点击「导入数据」
3. 上传 Excel 文件并映射字段
4. 确认导入

### Q2: 订单验证失败怎么办？

**答：** 检查以下几点：
1. 订单号是否正确（注意大小写、空格）
2. 「是否有效」是否为「有效」
3. 「到期时间」是否已过期
4. Coze 工作流中的筛选条件是否正确

### Q3: 如何自动处理过期订单？

**答：** 使用飞书自动化：
1. 在表格中点击「自动化」
2. 触发条件：到期时间 = 今天
3. 执行动作：将「是否有效」改为「已过期」

### Q4: 可以给不同用户设置不同的有效期吗？

**答：** 可以！每个订单都有独立的「到期时间」字段，可以自由设置。

### Q5: 如何导出订单数据？

**答：** 
1. 在表格中点击右上角「...」
2. 选择「导出」
3. 选择格式（Excel 或 CSV）
4. 下载文件

### Q6: 订单号被泄露了怎么办？

**答：** 
1. 立即在飞书表格中将该订单的「是否有效」改为「已禁用」
2. 为用户重新生成一个新订单号
3. 通知用户更新插件配置
4. 原订单号立即失效，泄露也无法使用

### Q7: 能否限制订单号的使用设备？

**答：** 
当前版本暂不支持设备限制。但通过以下方式可以间接限制：
1. 设置「剩余次数」，限制使用频率
2. 监控「最后使用时间」，发现异常及时禁用
3. 定期更换订单号

### Q8: 如何防止订单号被分享？

**答：** 
虽然无法完全阻止，但可以通过以下方式降低风险：
1. 在订单有效期和次数上做限制
2. 设置合理的价格，降低分享动机
3. 在用户协议中明确禁止分享
4. 监控使用频率，发现异常及时处理
5. 对于企业用户，签订保密协议

---

## 🎉 总结

使用飞书表格管理订单号的优势：

1. ✅ **简单直观** - 像 Excel 一样容易上手
2. ✅ **功能强大** - 支持筛选、排序、统计、自动化
3. ✅ **团队协作** - 多人可以同时管理
4. ✅ **实时生效** - 修改后立即在插件中生效
5. ✅ **无需编程** - 不需要写代码维护

**立即开始使用吧！** 🚀

---

**文档版本：** V1.0  
**最后更新：** 2025-01-04  
**作者：** 红薯助手团队

